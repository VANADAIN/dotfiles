#!/bin/sh

# Get WiFi status using NetworkManager
WIFI_INFO=$(nmcli -t -f active,ssid,signal,device dev wifi | grep '^yes' | head -1)

if [ -n "$WIFI_INFO" ]; then
    IFS=':' read -r active ssid signal device <<< "$WIFI_INFO"
    
    # Get IP for the WiFi device
    if [ -n "$device" ]; then
        IP_ADDR=$(ip addr show dev "$device" 2>/dev/null | grep -w "inet" | awk '{print $2}' | cut -d/ -f1 | head -1)
        if [ -n "$IP_ADDR" ]; then
            echo "$ssid ($signal%) - $IP_ADDR"
            echo "$ssid ($signal%) - $IP_ADDR"
        else
            echo "$ssid ($signal%)"
            echo "$ssid ($signal%)"
        fi
    else
        echo "$ssid ($signal%)"
        echo "$ssid ($signal%)"
    fi
    
    echo "#00FF00"  # Green when connected
else
    # Check if WiFi is disabled
    WIFI_STATUS=$(nmcli radio wifi)
    if [ "$WIFI_STATUS" = "disabled" ]; then
        echo "WiFi Off"
        echo "WiFi Off"
        echo "#FF0000"  # Red when off
    else
        # Check for Ethernet connection
        ETH_INFO=$(nmcli -t -f device,type dev status | grep ethernet | head -1 | cut -d: -f1)
        if [ -n "$ETH_INFO" ]; then
            IP_ADDR=$(ip addr show dev "$ETH_INFO" 2>/dev/null | grep -w "inet" | awk '{print $2}' | cut -d/ -f1 | head -1)
            if [ -n "$IP_ADDR" ]; then
                echo "Ethernet - $IP_ADDR"
                echo "Ethernet - $IP_ADDR"
                echo "#00FF00"
            else
                echo "Ethernet"
                echo "Ethernet"
                echo "#00FF00"
            fi
        else
            echo "No WiFi"
            echo "No WiFi"
            echo "#FFA500"  # Orange when available but not connected
        fi
    fi
fi

# Click handling (same as before)
case $BLOCK_BUTTON in
    1) nm-connection-editor & ;;
    2) 
        CURRENT_STATE=$(nmcli radio wifi)
        if [ "$CURRENT_STATE" = "enabled" ]; then
            nmcli radio wifi off
        else
            nmcli radio wifi on
        fi
        ;;
    3) nmcli dev wifi rescan ;;
esac
